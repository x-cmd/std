# shellcheck shell=sh disable=SC3043

# For alpine users
# Reference: https://blog.csdn.net/qq_33657251/article/details/107526842

___x_cmd_proxy_apk(){
    param:dsl <<A
subcommands:
    url             "Provide url of mirror candidates"
    replace|set     "Replace the download mirror"
    rollback        "Rollback the download mirror"
A
    param:run
    
    if ! command -v apk >/dev/null; then
        proxy_log error "command not found: apk, you should install apk in your system."
        return 1
    elif [ -n "$PARAM_SUBCMD" ]; then
        "___x_cmd_proxy_apk_${PARAM_SUBCMD}" "$@"
    else
        proxy_log error "Unknown subcommand: $PARAM_SUBCMD"
        ___x_cmd_proxy_apk _param_help_doc  >&2
    fi
}

___x_cmd_proxy_apk_url(){
    param:dsl <<A
subcommands:
    ustc           "USTC mirror"
    official       "Official mirror"
A
    param:run
    
    case "$PARAM_SUBCMD" in
        ustc)       printf "mirrors.ustc.edu.cn" ;;
        official)   printf "dl-cdn.alpinelinux.org" ;;
        *)          
                    printf "Unknown mirror: %s" "$PARAM_SUBCMD" >&2
                    ___x_cmd_proxy_apk_url _param_help_doc  >&2
                    ;;
    esac
}

___x_cmd_proxy_apk_replace() {
    param:dsl <<A
subcommands:
    ustc           "USTC mirror"
    official       "Official mirror"
A
    param:run

    local src_path
    src_path=/etc/apk/repositories
    ___proxy_backup "$src_path" apk

    sed -i "s/$(___x_cmd_proxy_apk_url official)/$(___x_cmd_proxy_apk_url "${PARAM_SUBCMD:-ustc}")/g" "$src_path"
}

___x_cmd_proxy_apk_rollback() {
    param:dsl <<A
advise:
    #1          x proxy apk rollback ls
options:
    #1          "use the selected file to rollback"
subcommand:
    ls          "list all file you can rollback"
A
    param:run

    if [ -n "$PARAM_SUBCMD" ]; then
        ___x_cmd_proxy_apk_rollback_"${PARAM_SUBCMD}" "$@"
        return
    fi

    if [ "$(id -u)" -ne 0 ]; then
        proxy_log info "using sudo"
        sudo ___proxy_rollback /etc/apk/repositories apk "$1"
    else
        ___proxy_rollback /etc/apk/repositories apk "$1"
    fi 
}

___x_cmd_proxy_apk_rollback_ls() {
    param:void
    ___proxy_rollback_ls apk
}

___x_cmd_proxy_apk_tutorial(){
    param:void
    cat <<A
A
}