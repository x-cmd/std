# shellcheck shell=sh disable=SC3043

proxy_apt(){
    param:dsl <<A
subcommand:
    url        "Provide url of mirror candidates"
    set        "Setting the mirror"
    unset      "Reset the source to the original official"
A
    param:run

    if ! command -v apt >/dev/null; then
        printf "apt NOT exists."
        return 1
    elif [ -n "$PARAM_SUBCMD" ]; then
        proxy_apt_"${PARAM_SUBCMD}" "$@"
    else
        proxy_apt _param_help_doc  >&2
    fi
}

proxy_apt_url(){
    param:dsl <<A
subcommand:
    ali                 "aliyun mirror url"
    tuna                "tuna mirror url"
A
    param:run

    case "$PARAM_SUBCMD" in
        # https://gems.ruby-china.com
        ali)                    printf mirrors.aliyun.com                   ;;
        tuna)                   printf mirrors.tuna.tsinghua.edu.cn        ;;
        # official)               printf http://snapshot.debian.org                ;;
        *)                      proxy_apt_url _param_help_doc >&2                  ;;
    esac
}

# Just replace the original text
proxy_apt_set() {
    param:dsl <<A
subcommand:
    ali                 "aliyun"
    tuna                "tuna"
A
    param:run

    # TODO: Some problem in ubuntu 12.04
    local url
    if url="$(proxy_apt_url "${PARAM_SUBCMD:-ali}")"; then
        proxy_log info "Setting proxy_apt mirror :
    $url"

        local bak_dir
        bak_dir="$HOME/.x-cmd/proxy/.backup"
        mkdir -p "$bak_dir"

        local src_fp 
        local bak_fp
        src_fp=/etc/apt/sources.list
        bak_fp="$bak_dir/sources.list.$(date +%Y%M%d_%0H%m%S).bak"

        proxy_log info "Backing up $src_fp to $bak_fp"
        cp $src_fp "$bak_fp"
        
        awk -v url="$url" -F '\n' '{ gsub("[a-z]+\\.(ubuntu\\.com|debian\\.org)", url, $1); print $1 }' < "$bak_fp" > "$src_fp"
    fi
}

# Rollback from the last backup file
proxy_apt_unset() {
    local src_fp
    src_fp=/etc/apt/sources.list

    # get the last backup file from the backup directory
    local bak_dir
    bak_dir="$HOME/.x-cmd/proxy/.backup"
    local bak_fp
    bak_fp="$bak_dir/$(ls -t "$bak_dir" | head -n 1)"

    if [ -f "$bak_fp" ]; then
        proxy_log info "Rollback from $bak_fp"
        cp "$bak_fp" "$src_fp"
    else
        proxy_log info "No backup file found in $bak_dir"
    fi
}