# shellcheck shell=sh disable=SC3043
# Reference: https://cloud.tencent.com/developer/article/1773630

proxy_go(){
    param:dsl <<A
subcommands:
    auto|autoset                       "Set the goproxy and gosumdb to recommended mirror"
    unset|reset                        "Reet the download mirror"
    gosumdb|sumdb|sum|gosum            "operations for gosumdb"
    set                                "Set the download mirror"
    service                            "Provide mirror service in docker or native binary"
    version                            "Show version"
    tutorial|xman                      "Tutorial for setting goproxy "                      
    help                               "Show help"
A
    param:run

    "proxy_go_${PARAM_SUBCMD}" "$@"
}

# Using web to judge instead of dig command
# net is-in-china
proxy_go_auto(){
    param:void
    # if dig sh.x-cmd.com 2>/dev/null | grep gitee 2>/dev/null 1>dev/null; then
    #     proxy_go set aliyun
    #     proxy_go sum set qiniu
    # else
    #     : Why
    # fi

    proxy_go set aliyun
    proxy_go gosumdb set qiniu
}

___proxy_go_set(){
    local url
    local code

    url="${1:?URL}"

    if [ "$(go version | awk '{ a=substr($3, 3); if(a<1.13) print 1; else print 0 }')" = 1 ]; then
        code="
    export GOPROXY=$url
    export GO111MODULE=on
"
    else
        code="
    go env -w GO111MODULE=on
    go env -w GOPROXY="$url,direct"
"
    fi

    eval "$code"
    printf "%s\n%s" "Seting the GORPOXY and GO111MODULE env with following code:" "$code" >&2
}

proxy_go_set(){
    param:dsl <<A
subcommand:
    aliyun|ali                  "Ali"
    goproxy|goproxy.cn          "goproxy.cn"
    qiniu|io|goproxy.io         "goproxy.io"
    official                    "Official"
A
    param:run

    case "${PARAM_SUBCMD:-qiniu}" in
        ali|aliyun)            ___proxy_go_set    https://mirrors.aliyun.com/goproxy/ ;;
        goproxy|goproxy.cn)    ___proxy_go_set    https://goproxy.io/zh/ ;;
        qiniu|io|goproxy.io)   ___proxy_go_set    https://goproxy.cn ;;
        *) ;;
    esac
}

proxy_go_gosumdb(){
    param:dsl <<A
subcommands:
    set                                "Set the download mirror"
    unset|reset|clear                  "Reset the download mirror"
A
    param:run

    "proxy_go_gosumdb_${PARAM_SUBCMD}" "$@"
}

proxy_go_gosumdb_set(){
    param:void
    case "${1:-qiniu}" in
        qiniu|io|goproxoy.io)   ___proxy_go_set    https://goproxy.cn ;;
        *)                      export GOSUMDB=gosum.io+ce6e7565+AY5qEHUk/qmHc5btzW45JVoENfazw8LielDsaI+lEbq6 ;;
    esac
}

proxy_go_gosumdb_unset(){
    param:void
    export GOSUMDB=
}

proxy_go_unset(){
    param:void
    local code

    if [ "$(go version | awk '{ a=substr($3, 3); if(a<1.13) print 1; else print 0 }')" = 1 ]; then
        code="
    export GOPROXY=
"
    else
        code="
    go env -u GOPROXY
"
    fi

    eval "$code"
    printf "Unset the GOPROXY env.\n" >&2
}

# help doc: https://goproxy.io/zh/docs/enterprise.html
proxy_go_service(){
    param:void
    if docker ps >/dev/null 2>&1; then
        docker run -d -p80:8081 goproxy/goproxy "$@"
    elif :; then
        : Build directly.
    else
        # Just download the exe file.
        ./bin/goproxy -listen=0.0.0.0:80 -cacheDir=/tmp/test -proxy https://goproxy.io -exclude "git.corp.example.com,rsc.io/private"
    fi
}

proxy_go_tutorial(){
    param:void
    cat <<A
Windows Powershell:

Format: \$env:GOPROXY = <url>

Example:
\$env:GOPROXY = "https://goproxy.cn"

Windows:

1. 右键 我的电脑 -> 属性 -> 高级系统设置 -> 环境变量
2. 在 “[你的用户名]的用户变量” 中点击 ”新建“ 按钮
3. 在 “变量名” 输入框并新增 “GOPROXY”
4. 在对应的 “变量值” 输入框中新增 “https://goproxy.io,direct”
5. 最后点击 “确定” 按钮保存设置    
A
}
