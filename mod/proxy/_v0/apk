# shellcheck shell=sh disable=SC3043

# For alpine users
# Reference: https://blog.csdn.net/qq_33657251/article/details/107526842

proxy_apk(){
    param:dsl <<A
subcommands:
    url             "Provide url of mirror candidates"
    get             "Get the mirror"
    replace         "Reet the download mirror"
    rollback        "Set the download mirror"
A
    param:run
    
    if ! command -v apk >/dev/null; then
        proxy_log error "command not found: apk"
        return 1
    elif [ -n "$PARAM_SUBCMD" ]; then
        "proxy_apk_${PARAM_SUBCMD}" "$@"
    else
        proxy_apk _param_help_doc  >&2
    fi
}

proxy_apk_url(){
    param:dsl <<A
subcommands:
    ustc           "USTC mirror"
    official       "Official mirror"
A
    param:run
    
    case "$PARAM_SUBCMD" in
        ustc)       printf "mirrors.ustc.edu.cn" ;;
        official)   printf "dl-cdn.alpinelinux.org" ;;
        *)          
                    printf "Unknown mirror: %s" "$PARAM_SUBCMD" >&2
                    proxy_apk_url _param_help_doc  >&2
                    ;;
    esac
}

proxy_apk_replace() {
    param:dsl <<A
subcommands:
    ustc           "USTC mirror"
    official       "Official mirror"
A
    param:run

    local src_path
    src_path=/etc/apk/repositories
    ___proxy_backup "$src_path" apk

    sed -i "s/$(proxy_apk_url official)/$(proxy_apk_url "${PARAM_SUBCMD:-ustc}")/g" "$src_path"
}

proxy_apk_rollback() {
    param:void

    if [ "$(id -u)" -ne 0 ]; then
        proxy_log info "using sudo"
        sudo ___proxy_rollback /etc/apk/repositories apk
    else
        ___proxy_rollback /etc/apk/repositories apk
    fi
}