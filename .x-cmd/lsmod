#! /usr/bin/env xsh


lsmod_getfp(){
    local filename=modlist
    local fp="$(pwd)/$filename"
    [ -f "$fp" ] && printf "%s" "$fp" && return

    fp="$(x wsroot)/$filename"
    [ -f "$fp" ] && printf "%s" "$fp" && return

    return 1
}

lsmod(){
    local fp
    fp="$(lsmod_getfp)" || {
        printf "Cannot find file modlist." >&3
        return
    }

    local mode="${1:-all}"
    while read -r line; do
        [ "${line#\#}" != "$line" ] && continue
        [ "$line" = "" ] && continue
        case "$mode" in
            core)   [ "$line" != "${line#+}" ] && printf "%s\n" "${line#+}" ;;
            all)    printf "%s\n" "${line#+}" ;;
            *)      [ "$line" != "${line#*${mode}*}" ] && printf "%s\n" "${line#+}" ;;
        esac
    done <"$(x wsroot)/modlist" 2>/dev/null
}

lsmod "$@"
